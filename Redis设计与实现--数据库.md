# Redis设计与实现--数据库（Redis设计与实现第九章）

* 服务器中的数据库

```C
struct redisServer {
    //服务器中的数据库数量，默认16
    int dbnum;

    //一个数组，保存服务器中的所有数据库，数量由dbnum决定
    redisDb *db;
}
```

- 数据库切换 [数据库切换](/images/redis/数据库切换.png)

* 数据库键空间：通过redis.h/redisDb结构表示

```C
typedef struct redisDb {

    //...

    //数据库键空间，保存着数据库中所有的键值对
    dict *dict;

    //过期时间，利用字典实现，键指向键空间的某个键对象，值是long long类型的，毫秒的精度
    dict *expires；

    //...
}
```
[数据库键空间例子](/images/redis/数据库键空间例子.png)

    * 读写键空间时的维护操作
        - 读取一个键之后，服务器更新键命中(hit)次数或者空间不命中(miss)次数
        - 读取一个键之后，更新LRU(最后一次使用)时间，用于计算键的空闲时间
        - 如果读取键时发现键过期，就删除这个键
        - 如果客户端使用WATCH命令监视某个键，那么键被修改之后，会将这个键标记为脏(dirty)，从而让事务程序之知道这个键已被修改了
    * 设置过期时间，最终都是通过PEXPIREAT来实现的
        - EXPIRE<key><ttl>，秒
        - PEXPIRE<key><ttl>，毫秒
        - EXPIREAT<key><timestamp>，秒时间戳
        - PEXPIREAT<key><ttl>，毫秒时间戳
![带有过期字典的数据库例子](/images/redis/带有过期字典的数据库例子.png)

* Redis过期删除策略：一般有三种，定时删除（定时器，对CPU不友好，对响应时间和吞吐量造成影响）、惰性删除（多CPU最友好，对内存不友好）、定期删除。redis采用惰性删除和定期删除的折中
    - 惰性删除策略：所有读写命令在执行前都会调用expireIdNeeded命令第对输入键进行检查
        - 如果输入键已过期，那么expireIfNeeded函数删除输入键
        - 如果未过期，expireIfNeeded不做动作
    - 定期删除：redis周期性的执行activeExpireCycle，函数会在规定的时间内分多次遍历服务器中的各个数据库，从数据库中expire字典随机检查一部分键的过期时间
- AOF、RDB和复制功能对过期键的处理
    - 生成和载入RDB，执行SAVE和GBSAVE命令创建RDB文件时，过期的数据不会保存，载入时主库不会载入过期键，从数据库会载入全部键，包括过期键
    - AOF文件写入：当过期键被惰性删除或者定期删除后，程序回想AOF文件追加一条DEL命令，来显示记录该键已被删除，AOP重写与RDB一样
    - AOF复制：从服务器的过期键阐述动作由主服务器控制：
        - （客户端向主服务器get数据）主服务器删除过期键后，会显式的向所有从服务器发送DEL命令，从服务器在执行客户端的读命令时，即使碰到过期键也不会将过期键删除，而是继续向处理未过期键那样处理过期键（会返回过期键的值）
