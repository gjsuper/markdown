# 极客时间--MySQL实战45讲--第12讲：为什么我的MySQL会抖一下

* 一条sql，正常执行非常快，但偶尔不知道怎么回事，会变得特别慢，这有可能是将redo log刷进数据页的时候（WAL），刷脏页
* 什么时候会刷脏页
    - InnoDB的redo log写满了。这时系统会停止所有更新操作，把checkpoint往前推进，redo log留出空间可以继续写，同时将这两点之间的的所有脏页刷进磁盘
    - 系统内存空间不足
    - MySQL认为系统空闲的时候
    - MySQL正常关闭的时候

* 第一种场景整个系统不能再接收更新了，所有的更新都必须堵住，是需要避免的。

* 第二种场景是内存不够用了，要先将脏页写进磁盘，这种情况是常态。innodb用缓冲池（buffer pool）管理内存，缓冲池中的内存页有三种状态：
    - 还没使用的
    - 使用了并且是干净页
    - 使用了并且是脏页
* 刷脏页虽然是常态，但是出现以下两种情况还是会影响性能：
1. 一个查询要淘汰的脏页个数太多，会导致相应时间明显变长
2. 日志写满，更新会全部堵住，写性能跌为0

* innodb会在后台刷脏页，而刷脏页的过程是要将内存页写入磁盘。所以，无论是你的查询语句在需要内存的时候可能要求淘汰一个脏页，还是由于刷脏页的逻辑会占用IO资源并可能影响到你的更新，都可能造成你从业务端感知到mysql抖了一下
* mysql刷脏页的一个策略：在准备刷一个脏页的时候，如果数据页旁边的数据页也是脏页，会把这个邻居也给刷掉。如果在机械硬盘的时代，这个策略是很有用的，可以减少很多随机IO，机械硬盘的随机IO一般只有几百。如果是SSD这类IOPS较高的设备，建议把innodb_flush_neighbors的值设为0.因为这时IOPS往往不是瓶颈，而只刷自己可以更快的完成刷脏页的操作。

* 如果innodb_io_capacity的值设置得太小（比如300），innodb会认为这个系统能力太差，所以刷脏页刷的也特别慢，甚至比脏页生成的速度都慢，这样造成了脏页累积，影响了查询性能和更新能力。
