# 极客时间--MySQL实战45讲--第13讲：为什么表数据删掉一半，表文件大小不变

* 删掉一行记录，磁盘文件的大小不会缩小，但这个位置会被复用，而且只能被某些数据复用（索引有序）
* 删除整个数据页，可以复用到任何位置，磁盘上的文件不会变小。delete整个表也是一样的。
* 删除数据和插入数据都可能导致空洞（页分裂）
* 重建表：现在需要做空间收缩，把表中的空洞去掉
    - 自己手动一行一行从表A读出来再插入到表B中
    - 可以使用 alter table A engine = InnoDB命令来重建表，自动完成了转存数据、交换表名、删除旧表的操作。

    [改锁表DDL](../images/mysql实战45讲/改锁表DDL.png)

在5.6之前，整个DDL过程中，表A不能做更新、插入操作，5.6之后，引入了Online DDL，对这个流程做了优化：

1. 建立一个临时表，扫描表A主键的所有数据
2. 用数据页中表A的记录生成B+树，存储到临时表
3. 生成临时文件的过程中，将所有对表Ade操作记录在一个日志文件（row log）中，对应的是图中state的状态；
4. 临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据与表相同的数据文件，对于途中3的状态
5. 用临时表替换表Ade数据文件
[onlineDDL]{../images/mysql实战45讲/onlineDDL.png}

* online和inplace
    - 在第一个图中，表A中导出的数据在tmp_file中，这是一个临时表，是在server层中。
    - 第二个图中，tmp_file是在InnoDB内部创建的。整个DDL过程都在InnoDB内部完成。对于server层来说，没有把数据挪动到临时表，是一个原地的操作，这就是“implace"名称的来源。
