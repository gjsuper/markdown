# Redis设计与实现--复制（Redis设计与实现第十五章）

* 新版（2.8之后）复制功能：为了解决复制功能在处理断线重复复制情况下的低效问题，使用PAYNC代替SYNC命令来执行复制时的同步操作。（旧版的断线复制 从库会发送SYNC命令给主库，主库会BGSAVE，写所有的数据到RDB文件，然后把RDB文件发给从库，这会消耗主库大量的带宽和CPU，而从库在重新根据RDB文件同步数据时，会处理大量的重复数据）
* PSYNC命令具有完整重同步和部分重同步两种模式：
    - 完全重同步：用于处理初次复制情况，与执行SYNC一样，都是通过让主服务器创建并发送RDB文件，以及向从服务器发送保存在缓冲区里面的写命令来进行同步
    - 部分重同步：用于处理断线后重复制情况，主服务器将主从断开连接期间执行的写命令发送到从服务器，从服务器只要接受并执行这些命令即可
- 部分重同步实现
    - 复制偏移量：主从服务器都会维护一个偏移量
        - 主服务器每次向从服务器传播N个字节，就将自己的复制偏移量加N
        - 从服务器每次收到N字节，就将自己的偏移量加N
        - 通过主从服务器的偏移量对比，就可以知道是否同步
    - 复制挤压缓冲区：主服务器的一个先进先出队列，默认1，缓冲区记录了最近的命令和参数，以字符形式保存，每个字符都对应一个偏移量，从服务器会通过将PSYNC命令将自己的复制屁啊你量offset发送给主服务器
        - 如果offset偏移量之后的数据依然存在于复制积压缓冲区，那么就执行部分重同步操作
        - 如果不存在，就执行完整重同步
    - 服务器运行ID：重回服务器初次对主服务器进行复制时，主服务器会将自己的id传送给从服务器保存起来，重连之后从服务器回向主服务器发送和这个保存的ID
        - 如果从服务器发送的ID与主服务器的ID一样，说明和之前练的是同一个主服务器，就执行部分重同步
        - 如果id不一样，就执行完整重同步
- PSYNC命令的实现 (15.5)[PSYNC主从同步过程](/images/redis/PSYNC主从同步过程.png)
- 复制的实现
    1. 设置主服务器的地址和端口：SLAVEOF 127.0.0.1：6379
    2. 建立套接字连接
    3. 发送ping命令 [发送ping命令](/images/redis/发送ping命令.png)
    4. 身份验证
    5. 发送端口信息
    6. 同步
    7. 命令传播
* 心跳检测：REPLCONF ACK <replication_offset> 每秒钟发送一次，作用：
    - 检测主从服务器的网络连接状态
    - 辅助实现min-slaves配置选项：redis的min-slaves-to-write和min-slaves-max-lag，可以防止在不安全的情况下执行写命令：

            min-slaves-to-write 3
            min-slaves-max-lag
            那么从服务器数量小于3个，或者三个从服务器延迟不小于10秒时，主服务器将拒绝写命令
    - 检测命令丢失:主服务器根据REEPLCONF ACK中的偏移量来检测是否在同步时有写命令丢失，如果有的话，会根据心跳检测中的偏移量重新发送写命令给从服务器
