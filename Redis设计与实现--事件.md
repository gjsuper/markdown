# Redis设计与实现--AOF持久化（Redis设计与实现第十二章）

* redis是个事件驱动程序：服务器需要两类事件：
    - 文件事件：Redis通过套接字与客户端连接，通过与客户端的通信产生文件事件
    - 时间事件
- 文件事件
    - 文件事件处理器</br>
    [文件事件处理器的四个组成部分](/Users/jingjie/Documents/markdown/images/redis文件事件处理器的四个组成部分.png)
    - I/O多路复用允许服务器同时监听AE_READABLE事件和AE_WRITEABLE事件，如果这两种事件同时产生，会优先处理AE_READABLE事件，也就是说一个套接字即可读又可写，那么会先读套接字，后写套接字
    - 文件事件的处理器
        - 连接应答处理器
        - 命令请求处理器
        - 命令回复处理器
- 时间事件
    - 定时事件：让一段程序在指定的时间执行
    - 周期事件：让一段时间每隔指定时间就执行一次，目前redis只使用周期性时间，而没使用定时事件
    - 时间事件的组成：
        - id：服务器为时间事件创建的全局唯一ID，递增
        - when：毫秒精度，记录时间的到达时间(到达是指：when属性的时间戳小于等于当前时间戳)
        - timeProc：时间事件处理器，一个函数。当时间事件到达后，服务器会调用相应的处理器来处理事件
    - 一个时间是定时事件还是周期性时间是由时间处理器的返回值决定
        - 如果时间处理器返回一个ae.h/AE_NOMORE，那么这个事件就是定时事件：该事件在达到一次之后就会被删除，之后不再到达
        - 如果返回值为非AE_NOMORE的整数值，那么该事件就是周期性事件，当一个时间事件到达后，服务器根据事件处理器的返回值对时间事件的when属性进行更新，让这个事件在一段时间后再次到达
    - 实现：服务器将时间事件放在一个无序链表中（不按when排序，按id从大到小排），每当事件到达时，就遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器 ![时间事件数据结构](/images/redis/时间事件数据结构.png)
    - serverCron函数定期（每秒运行10次）对自身资源和状态进行检查和调整
- 文件事件和时间事件是合作关系，服务器会轮流处理这两种事件，并且处理事件的过程也不会进行抢占
- 时间事件的实际处理时间通常会比设定的到达时间晚一些
