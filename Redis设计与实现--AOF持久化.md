# Redis设计与实现--AOF持久化（Redis设计与实现第十一章）

* RDB持久化通过保存数据库中的键值对来记录数据库状态的不同，AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库的
* AOP持久化的实现：命令追加、文件写入、文件同步
    - 命令追加：当AOF持久化功能处于打开状态时，服务器在执行完一个写命令后，会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓冲区的末尾：
```C
struct redisServer {
    //...

    //AOF缓冲区
    sds aof_buf;

    //...
}
```

* AOF文件的载入
    1. 创建一个不带网络连接的伪客户端：因为Redis的命令只能在客户端上下文中执行，而载入AOF文件时所使用的命令全部来自于AOF文件而不是网络连接，所以服务器使用了一个没有网络连接的伪客户端来执行AOF文件红中的写命令，伪客户端执行的效果和带网络连接的客户端执行的命令效果完全一样。
    2. 从AOF文件中分析并读取出一条写命令
    3. 使用伪客户端执行被读出的写命令
    4. 重复2、3，知道AOF中的命令被全部读完

    [AOF文件载入过程](/images/redis/AOF文件载入过程.png)

* AOF文件的数据重写
    - 随着服务器的运行，AOF文件会越来越大，使用AOF来进行数据还原所需的时间也越来越多

    - 实现方式：虽然讲新生AOF文件替换AOF旧文件的功能个命名为“AOF文件重写”，实际上AOF重写并不需要对现有的AOF文件进行任何读取、分析或者写入操作，这个高性能呢过是通过读取当前数据库的状态实现的

    - AOF后台重写原理：为了应对在重写过程中有新的写命令被执行的情况，而新的命令可能会对现有的互数据库转改进行修改，从而使得服务器当前的数据库状态和重写后的AOF文件不一致的情况。Redis新增了AOF重写缓冲区，在重写期间，服务器的需要执行：
        - 执行客户端发来的命令
        - 将执行后的写命令追加到AOF缓冲区
        - 将执行后的写命令追加到AOF重写缓冲区


[AOF缓冲区](/images/redis/AOF缓冲区.png)

    这样一来就可以保证
        - AOF缓冲区的内容会定期被写入和同步到AOF文件，对现有AOF文件的处理工作会照常进行
        - 从创建子进程重写AOF文件开始，服务器所执行的写命令都会被记录到AOF重写缓冲区里面
        - 当子进程完成AOF重写工作后，他会向父进程发送一个信号，父进程在接到信号后会调用一个信号函数进行以下工作：
            - 将AOF重写缓冲区的数据写入到新的AOF文件中，这时新的AOF文件所保存的数据库状态和当前的数据库状态就是一致的
            - 对新的AOF文件进行改名，原子的覆盖现有的AOF文件，完成新旧AOF文件的替换
